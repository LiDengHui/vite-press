import{F as e,J as t,T as n,b as r,f as i,k as a,m as o,p as s,q as c,r as l}from"./chunks/plugin-vue_export-helper.CL7LGUog.js";const u=JSON.parse(`{"title":"Rollup生命周期","description":"","frontmatter":{},"headers":[],"relativePath":"工程化/Rollup/Rollup生命周期.md","filePath":"工程化/Rollup/Rollup生命周期.md","lastUpdated":1751247407000}`),d={name:`工程化/Rollup/Rollup生命周期.md`};function f(r,u,d,f,p,m){let h=t(`Mermaid`);return e(),o(`div`,null,[u[1]||=s(`<h1 id="rollup生命周期" tabindex="-1">Rollup生命周期 <a class="header-anchor" href="#rollup生命周期" aria-label="Permalink to “Rollup生命周期”">​</a></h1><p>Rollup.js 的构建过程分为 <strong>Build</strong>（构建）和 <strong>Output</strong>（输出）两大阶段，每个阶段包含多个子流程，并通过<strong>插件钩子（Hooks）</strong> 实现扩展性。以下是各阶段的详细作用和执行流程：</p><div class="legend-grid"><div style="grid-column:1;grid-row:1;"><span class="legend-rect" style="background:#ffb3b3;"></span>parallel </div><div style="grid-column:1;grid-row:2;"><span class="legend-rect" style="background:#ffd2b3;"></span>sequential </div><div style="grid-column:1;grid-row:3;"><span class="legend-rect" style="background:#fff2b3;"></span>first </div><div style="grid-column:2;grid-row:1;"><span class="legend-rect" style="border-color:#000;"></span>async </div><div style="grid-column:2;grid-row:2;"><span class="legend-rect" style="border-color:#f00;"></span>sync </div></div>`,3),(e(),a(i,null,{default:n(()=>[l(h,{id:`mermaid-8`,class:`mermaid my-class main img`,graph:`flowchart%20TB%0A%20%20%20%20classDef%20default%20fill%3Atransparent%2C%20color%3A%23000%3B%0A%20%20%20%20classDef%20hook-parallel%20fill%3A%23ffb3b3%2Cstroke%3A%23000%3B%0A%20%20%20%20classDef%20hook-sequential%20fill%3A%23ffd2b3%2Cstroke%3A%23000%3B%0A%20%20%20%20classDef%20hook-first%20fill%3A%23fff2b3%2Cstroke%3A%23000%3B%0A%20%20%20%20classDef%20hook-sequential-sync%20fill%3A%23ffd2b3%2Cstroke%3A%23f00%3B%0A%20%20%20%20classDef%20hook-first-sync%20fill%3A%23fff2b3%2Cstroke%3A%23f00%3B%0A%0A%09watchchange(%22watchChange%22)%3A%3A%3Ahook-parallel%0A%09click%20watchchange%20%22%23watchchange%22%20_parent%0A%0A%20%20%20%20closewatcher(%22closeWatcher%22)%3A%3A%3Ahook-parallel%0A%09click%20closewatcher%20%22%23closewatcher%22%20_parent%0A%0A%09buildend(%22buildEnd%22)%3A%3A%3Ahook-parallel%0A%09click%20buildend%20%22%23buildend%22%20_parent%0A%0A%20%20%20%20buildstart(%22buildStart%22)%3A%3A%3Ahook-parallel%0A%09click%20buildstart%20%22%23buildstart%22%20_parent%0A%0A%09load(%22load%22)%3A%3A%3Ahook-first%0A%09click%20load%20%22%23load%22%20_parent%0A%0A%09moduleparsed(%22moduleParsed%22)%3A%3A%3Ahook-parallel%0A%09click%20moduleparsed%20%22%23moduleparsed%22%20_parent%0A%0A%09options(%22options%22)%3A%3A%3Ahook-sequential%0A%09click%20options%20%22%23options%22%20_parent%0A%0A%09resolvedynamicimport(%22resolveDynamicImport%22)%3A%3A%3Ahook-first%0A%09click%20resolvedynamicimport%20%22%23resolvedynamicimport%22%20_parent%0A%0A%09resolveid(%22resolveId%22)%3A%3A%3Ahook-first%0A%09click%20resolveid%20%22%23resolveid%22%20_parent%0A%0A%09shouldtransformcachedmodule(%22shouldTransformCachedModule%22)%3A%3A%3Ahook-first%0A%09click%20shouldtransformcachedmodule%20%22%23shouldtransformcachedmodule%22%20_parent%0A%0A%09transform(%22transform%22)%3A%3A%3Ahook-sequential%0A%09click%20transform%20%22%23transform%22%20_parent%0A%0A%20%20%20%20options%0A%20%20%20%20--%3E%20buildstart%0A%20%20%20%20--%3E%20%7Ceach%20entry%7Cresolveid%0A%20%20%20%20.-%3E%20%7Cexternal%7Cbuildend%0A%0A%20%20%20%20resolveid%0A%20%20%20%20--%3E%20%7Cnon-external%7Cload%0A%20%20%20%20--%3E%20%7Cnot%20cached%7Ctransform%0A%20%20%20%20--%3E%20moduleparsed%0A%20%20%20%20.-%3E%20%7Cno%20imports%7Cbuildend%0A%0A%20%20%20%20load%0A%20%20%20%20--%3E%20%7Ccached%7Cshouldtransformcachedmodule%0A%20%20%20%20--%3E%20%7Cfalse%7Cmoduleparsed%0A%0A%20%20%20%20shouldtransformcachedmodule%0A%20%20%20%20--%3E%20%7Ctrue%7Ctransform%0A%0A%20%20%20%20moduleparsed%0A%20%20%20%20--%3E%20%7C%22each%20import()%22%7Cresolvedynamicimport%0A%20%20%20%20--%3E%20%7Cnon-external%7Cload%0A%0A%20%20%20%20moduleparsed%0A%20%20%20%20--%3E%20%7C%22each%20import(cached)%22%7Cload%0A%0A%20%20%20%20moduleparsed%0A%20%20%20%20--%3E%20%7C%22each%20import(not%20cached)%22%7Cresolveid%0A%0A%20%20%20%20resolvedynamicimport%0A%20%20%20%20.-%3E%20%7Cexternal%7Cbuildend%0A%0A%20%20%20%20resolvedynamicimport%0A%20%20%20%20--%3E%20%7Cunresolved%7Cresolveid%0A`})]),fallback:n(()=>u[0]||=[c(` Loading... `,-1)]),_:1})),u[2]||=s(`<h2 id="🔧-一、build-阶段-依赖解析与模块图生成" tabindex="-1">🔧 <strong>一、Build 阶段：依赖解析与模块图生成</strong> <a class="header-anchor" href="#🔧-一、build-阶段-依赖解析与模块图生成" aria-label="Permalink to “🔧 一、Build 阶段：依赖解析与模块图生成”">​</a></h2><p><strong>目标</strong>：解析入口文件，构建模块依赖图（Module Graph），生成模块的抽象语法树（AST）。<br><strong>流程</strong>：</p><ol><li><p><strong><code>options</code> 钩子</strong></p><ul><li><strong>作用</strong>：转换或修改 Rollup 配置（如修改输入路径）。</li><li><strong>类型</strong>：<code>async, sequential</code>（按插件顺序执行）。</li></ul></li><li><p><strong><code>buildStart</code> 钩子</strong></p><ul><li><strong>作用</strong>：初始化构建状态（如清理缓存、预加载资源）。</li><li><strong>类型</strong>：<code>async, parallel</code>（插件并行执行）。</li></ul></li><li><p><strong><code>resolveId</code> 钩子</strong></p><ul><li><strong>作用</strong>：解析模块路径（如处理别名 <code>@/utils</code> → <code>src/utils.js</code>）。</li><li><strong>类型</strong>：<code>async, first</code>（一旦某个插件返回有效路径，则停止后续解析）。</li></ul></li><li><p><strong><code>load</code> 钩子</strong></p><ul><li><strong>作用</strong>：加载模块内容（如读取文件或返回虚拟模块）。</li><li><strong>示例</strong>：加载 JSON 文件时，<code>@rollup/plugin-json</code> 将其转为 JS 对象。</li></ul></li><li><p><strong><code>transform</code> 钩子</strong></p><ul><li><strong>作用</strong>：转换模块代码（如 Babel 转译、替换环境变量）。</li><li><strong>类型</strong>：<code>async, sequential</code>（插件串行执行，前一个结果作为下一个输入）。</li></ul></li><li><p><strong><code>moduleParsed</code> 钩子</strong></p><ul><li><strong>作用</strong>：模块 AST 解析完成后触发，收集 <code>import</code> 依赖关系，递归解析子模块。</li></ul></li><li><p><strong><code>buildEnd</code> 钩子</strong></p><ul><li><strong>作用</strong>：构建结束（成功或失败时执行清理操作）。</li></ul></li></ol><p><strong>输出</strong>：生成 <code>bundle</code> 对象，包含模块依赖图、AST 和原始代码，但尚未打包。</p><h2 id="📦-二、output-阶段-代码打包与产物生成" tabindex="-1">📦 <strong>二、Output 阶段：代码打包与产物生成</strong> <a class="header-anchor" href="#📦-二、output-阶段-代码打包与产物生成" aria-label="Permalink to “📦 二、Output 阶段：代码打包与产物生成”">​</a></h2><p><strong>目标</strong>：将模块依赖图转换为优化后的最终产物（如单文件或代码分割的 chunk）。<br><strong>流程</strong>：</p><ol><li><p><strong><code>outputOptions</code> 钩子</strong></p><ul><li><strong>作用</strong>：修改输出配置（如动态调整输出格式 <code>esm</code> → <code>cjs</code>）。</li></ul></li><li><p><strong><code>renderStart</code> 钩子</strong></p><ul><li><strong>作用</strong>：输出阶段开始的初始化。</li></ul></li><li><p><strong>关键代码优化</strong></p><ul><li><strong>Tree Shaking</strong>：静态分析 AST，删除未使用的代码（需 ES 模块语法）。</li><li><strong>作用域提升（Scope Hoisting）</strong>：将模块合并到单一作用域，减少运行时开销。</li></ul></li><li><p><strong><code>banner/footer/intro/outro</code> 钩子</strong></p><ul><li><strong>作用</strong>：在产物首尾添加自定义内容（如版权声明）。</li></ul></li><li><p><strong><code>renderChunk</code> 钩子</strong></p><ul><li><strong>作用</strong>：处理单个 chunk 的代码（如压缩、添加 Sourcemap）。</li><li><strong>常用插件</strong>：<code>rollup-plugin-terser</code> 压缩代码。</li></ul></li><li><p><strong><code>generateBundle</code> 钩子</strong></p><ul><li><strong>作用</strong>：所有 chunk 生成后，修改最终产物（如注入全局变量）。</li></ul></li><li><p><strong><code>writeBundle</code> 钩子</strong></p><ul><li><strong>作用</strong>：产物写入磁盘前的最后操作（如校验文件大小）。</li></ul></li><li><p><strong><code>closeBundle</code> 钩子</strong></p><ul><li><strong>作用</strong>：构建完全结束（关闭文件句柄、释放内存）。</li></ul></li></ol><p><strong>输出</strong>：</p><ul><li>通过 <code>bundle.generate()</code> 返回内存中的代码（适用于 SSR）。</li><li>通过 <code>bundle.write()</code> 将产物写入磁盘（如 <code>dist/bundle.js</code>）。</li></ul><h2 id="⚙️-三、插件钩子的核心类型与作用" tabindex="-1">⚙️ <strong>三、插件钩子的核心类型与作用</strong> <a class="header-anchor" href="#⚙️-三、插件钩子的核心类型与作用" aria-label="Permalink to “⚙️ 三、插件钩子的核心类型与作用”">​</a></h2><p>Rollup 的插件机制依赖以下钩子类型，控制执行逻辑：</p><table tabindex="0"><thead><tr><th><strong>钩子类型</strong></th><th><strong>作用</strong></th><th><strong>示例钩子</strong></th></tr></thead><tbody><tr><td><strong>Async/Sync</strong></td><td>异步钩子可返回 Promise；同步钩子需立即返回结果</td><td><code>transform</code>（Async）</td></tr><tr><td><strong>Parallel</strong></td><td>并发执行插件逻辑（如 <code>buildStart</code>）</td><td><code>buildStart</code></td></tr><tr><td><strong>Sequential</strong></td><td>串行执行，前一个插件的返回值作为下一个的输入</td><td><code>transform</code></td></tr><tr><td><strong>First</strong></td><td>一旦某个插件返回非 <code>null</code> 值，则停止后续执行</td><td><code>resolveId</code></td></tr></tbody></table><h2 id="🌟-四、关键优化技术" tabindex="-1">🌟 <strong>四、关键优化技术</strong> <a class="header-anchor" href="#🌟-四、关键优化技术" aria-label="Permalink to “🌟 四、关键优化技术”">​</a></h2><ol><li><strong>Tree Shaking</strong><ul><li>依赖 ES 模块的静态结构，移除未使用的代码（如未导出的函数）。</li></ul></li><li><strong>代码分割（Code Splitting）</strong><ul><li>通过动态导入（<code>import()</code>）分割代码，生成按需加载的 chunk。</li></ul></li><li><strong>格式兼容</strong><ul><li>支持输出 <code>esm</code>、<code>cjs</code>、<code>iife</code> 等多种格式，适配不同环境。</li></ul></li></ol><h2 id="💎-总结" tabindex="-1">💎 <strong>总结</strong> <a class="header-anchor" href="#💎-总结" aria-label="Permalink to “💎 总结”">​</a></h2><p>Rollup 通过 <strong>Build → Output</strong> 两阶段实现高效打包：</p><ul><li><strong>Build 阶段</strong>：解析模块依赖关系，粒度到<strong>单个文件</strong>，核心是生成模块图。</li><li><strong>Output 阶段</strong>：优化（Tree Shaking、作用域提升）并输出代码，粒度到 <strong>chunk</strong>（打包后的代码块）。<br><strong>插件系统</strong>是 Rollup 扩展性的核心，开发者可通过钩子介入每个子流程，实现路径别名、代码压缩等复杂需求。</li></ul>`,17)])}var p=r(d,[[`render`,f]]);export{u as __pageData,p as default};